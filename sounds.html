<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム音声波形</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js-sound/1.0.1/p5.sound.min.js"></script>
</head>
<body>
    <h1>リアルタイム音声波形2</h1>
    <button id="startButton">マイクを開始</button>
    <p id="statusMessage">※ボタンを押すとマイクが有効になります</p>

    <script>
        let mic, fft;

        function setup() {
            createCanvas(600, 300);
            background(0);
            fft = new p5.FFT();
        }

        function draw() {
            background(0);

            if (mic && mic.enabled) {
                let waveform = fft.waveform(); // 音声波形データを取得

                stroke(255);
                noFill();
                beginShape();

                for (let i = 0; i < waveform.length; i++) {
                    let x = map(i, 0, waveform.length, 0, width);
                    let y = map(waveform[i], -1, 1, 0, height);
                    vertex(x, y);
                }

                endShape();
            }
        }

        // マイクを有効化する関数
        function startMic() {
            userStartAudio().then(() => {
                if (!mic) {
                    mic = new p5.AudioIn();
                    mic.start().then(() => {
                        if (mic.enabled) {
                            fft.setInput(mic);
                            document.getElementById("statusMessage").innerText = "✅ マイクが有効になりました！";
                            console.log("マイクが有効になりました");
                        } else {
                            document.getElementById("statusMessage").innerText = "❌ マイクが有効になりませんでした";
                            console.warn("mic.enabled が false のまま");
                        }
                    }).catch(err => {
                        console.error("マイクの起動に失敗:", err);
                        document.getElementById("statusMessage").innerText = "❌ マイクの許可が必要です";
                    });
                }
            }).catch(err => {
                console.error("オーディオの初期化に失敗:", err);
                document.getElementById("statusMessage").innerText = "❌ オーディオの初期化に失敗しました";
            });
        }

        document.getElementById("startButton").addEventListener("click", startMic);
    </script>
</body>
</html>
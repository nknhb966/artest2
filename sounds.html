<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
</head>
<body>
  <button onclick="beginDetect()">aボリューム検出の開始</button>
  <p id="output"></p>

<script>
var audioContext;
var analyser;
var dataArray;

function beginDetect() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }

  navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
    const mediaStreamSource = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    mediaStreamSource.connect(analyser);
    updateVolume();
  });
}

function updateVolume() {
  analyser.getByteFrequencyData(dataArray);
  let sum = dataArray.reduce((acc, val) => acc + val, 0);
  let volume = sum / dataArray.length; // 平均値を計算

  document.getElementById("output").innerHTML = "ボリューム: " + volume.toFixed(2);
  requestAnimationFrame(updateVolume);
}
</script>
</body>
</html>